<?xml version="1.0" encoding="UTF-8"?>
<api context="/default" name="csr-accounts" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="GET" uri-template="/accounts-by-name">
        <inSequence>
            <log level="custom">
                <property expression="$trp:user_id" name="user_id"/>
            </log>
            <sequence key="AuthenticationRequestHeaderSequence"/>
            <sequence key="EndpointConfigSequence"/>
            <filter xpath="$ctx:query.param.account_name">
                <then>
                    <call>
                        <endpoint>
                            <http method="get" uri-template="{uri.var.protocol}://{uri.var.host}:{uri.var.port}/{uri.var.path}?account_name={query.param.account_name}">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </http>
                        </endpoint>
                    </call>
                    <header expression="$ctx:query.param.account_name" name="account_name" scope="transport"/>
                </then>
                <else>
                    <call>
                        <endpoint>
                            <http method="get" uri-template="{uri.var.protocol}://{uri.var.host}:{uri.var.port}/{uri.var.path}">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </http>
                        </endpoint>
                    </call>
                </else>
            </filter>
            <sequence key="ResponseHeadersSequence"/>
            <log level="custom">
                <property expression="$ctx:user_id" name="user_idf"/>
                <property expression="$trp:account_name" name="account_name"/>
                <property expression="$trp:number_of_accounts" name="account_number"/>
            </log>
            <loopback/>
        </inSequence>
        <outSequence>
            <respond/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="GET" uri-template="/accounts-by-type">
        <inSequence>
            <log level="custom">
                <property expression="$trp:user_id" name="UserId"/>
            </log>
            <sequence key="AuthenticationRequestHeaderSequence"/>
            <sequence key="EndpointConfigSequence"/>
            <filter xpath="$ctx:query.param.account_type">
                <then>
                    <call>
                        <endpoint>
                            <http method="get" uri-template="{uri.var.protocol}://{uri.var.host}:{uri.var.port}/{uri.var.path}?account_type={query.param.account_type}">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </http>
                        </endpoint>
                    </call>
                    <header expression="$ctx:query.param.account_type" name="account_type" scope="transport"/>
                </then>
                <else>
                    <call>
                        <endpoint>
                            <http method="get" uri-template="{uri.var.protocol}://{uri.var.host}:{uri.var.port}/{uri.var.path}?account_type=business">
                                <suspendOnFailure>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </http>
                        </endpoint>
                    </call>
                    <header name="account_type" scope="transport" value="business"/>
                </else>
            </filter>
            <sequence key="ResponseHeadersSequence"/>
            <log level="custom">
                <property expression="$ctx:user_id" name="User_Id"/>
                <property expression="$trp:number_of_accounts" name="Account_Number"/>
                <property expression="$trp:account_type" name="Account_Type"/>
            </log>
            <loopback/>
        </inSequence>
        <outSequence>
            <respond/>
        </outSequence>
        <faultSequence/>
    </resource>
    <resource methods="POST" uri-template="/accounts">
        <inSequence>
            <property expression="json-eval($.length())" name="number_of_accounts" scope="default" type="INTEGER"/>
            <clone>
                <target>
                    <sequence>
                        <log level="full"/>
                        <store description="Post Account" messageStore="AccountMessageStore"/>
                        <log level="full" separator="************************************* After Store Message ***************************************"/>
                    </sequence>
                </target>
                <target>
                    <sequence>
                        <log level="full" separator="."/>
                        <payloadFactory media-type="json">
                            <format>{&#xd;
	message: "Accounts submitted"&#xd;
}
							</format>
                            <args/>
                        </payloadFactory>
                        <header expression="$ctx:number_of_accounts" name="number_of_accounts" scope="transport"/>
                        <header expression="$trp:user_id" name="csr_user_id" scope="transport"/>
                        <log level="full"/>
                        <respond/>
                    </sequence>
                </target>
            </clone>
            <loopback/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
</api>
